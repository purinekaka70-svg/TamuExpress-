<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multi-Hotel Delivery System</title>
<script src="https://cdn.tailwindcss.com">

</script>
<style>
body.dark { background:#111; color:#eee; }
body.dark .bg-white { background:#222; }
body.dark .text-gray-600 { color:#ccc; }
body.dark input, body.dark select { background:#333; color:#eee; border-color:#555; }
</style>
</head>
<body class="bg-gray-100">
<header class="bg-green-600 text-white p-4 flex justify-between items-center">
<h1 class="font-bold text-lg">Hotel Delivery</h1>
<nav class="flex items-center space-x-2">
<button class="tab px-3" data-tab="restaurants">Restaurants</button>
<button class="tab px-3" data-tab="orders">Orders</button>
<button class="tab px-3" data-tab="hotel">Hotel Portal</button>
<button class="tab px-3" data-tab="admin">Admin</button>
<button id="toggleTheme" class="px-3 py-1 bg-gray-700 rounded">üåô</button>
<button id="resetData" class="px-3 py-1 bg-red-500 rounded">Reset Data</button>
</nav>
</header>








<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyApi2RjwEXEW2mTwCMiYERKUNAYL8Toddk",
    authDomain: "tamuexpress-26e4a.firebaseapp.com",
    projectId: "tamuexpress-26e4a",
    storageBucket: "tamuexpress-26e4a.firebasestorage.app",
    messagingSenderId: "202068792631",
    appId: "1:202068792631:web:8a9b97028ebd7a45af76b2",
    measurementId: "G-QKL8GLGQ53"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>

<main class="p-4" id="app"></main>

<script>
const OWNER_NUMBER = "0115613332";
const SERVICE_FEE = 30;
const SUBSCRIPTION_FEE = 100;
const ADMIN_USER = {name:"TamuExpress", pass:"dfgs8"};

let hotels = JSON.parse(localStorage.getItem("hotels") || "[]");
let restaurants = JSON.parse(localStorage.getItem("restaurants") || "[]");
let orders = JSON.parse(localStorage.getItem("orders") || "[]");
let cart = [];
let currentTab = "restaurants";
let currentHotelId = null;
let currentAdmin = null;
let isDark = JSON.parse(localStorage.getItem('darkMode') || "false");
document.body.classList.toggle('dark', isDark);

function saveData() {
    localStorage.setItem("hotels", JSON.stringify(hotels));
    localStorage.setItem("restaurants", JSON.stringify(restaurants));
    localStorage.setItem("orders", JSON.stringify(orders));
}

function escapeHTML(str) { return (str || "").replace(/[&<>'"]/g, t => ({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;","\"":"&quot;"}[t])); }
function getHotelById(id) { return hotels.find(h => h.id === id) || {name:'Unknown', till:'-'}; }

// ------------------ RENDER FUNCTION ------------------
function render() {
    const app = document.getElementById("app");

    // --- Restaurants Tab ---
    if(currentTab === "restaurants") {
        if(restaurants.length === 0) {
            app.innerHTML = "<p>No restaurants available.</p>";
            return;
        }
        app.innerHTML = `
        <h2 class="text-xl font-semibold mb-4">Restaurants</h2>
        <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
            ${restaurants.map(r => `
            <div class="bg-white shadow rounded p-4">
                <h3 class="font-bold">${escapeHTML(r.name)} (${escapeHTML(getHotelById(r.hotelId).name)})</h3>
                <p class="text-sm text-gray-600">${escapeHTML(r.description)}</p>
                <div class="mt-2">
                    ${r.menu && r.menu.length > 0 ? r.menu.map(m => `
                    <div class="flex justify-between items-center border-b py-1">
                        <span>${escapeHTML(m.name)} (${escapeHTML(m.description || 'No description')}) - KSh ${m.price}</span>
                        <button class="bg-green-500 text-white px-2 py-1 rounded text-sm addToCartBtn" 
                        data-id="${r.id}" data-name="${escapeHTML(m.name)}" data-price="${m.price}" data-hotel="${r.hotelId}">Add</button>
                    </div>`).join("") : `<p class="text-gray-500">No menu items yet.</p>`}
                </div>
            </div>`).join("")}
        </div>
        <div class="mt-6 bg-white shadow rounded p-4">
            <h3 class="font-bold mb-2">Cart</h3>
            ${cart.length === 0 ? `<p>Cart is empty</p>` : `
            <ul>
                ${cart.map((c,i) => `<li>${escapeHTML(c.name)} - KSh ${c.price} <button class="removeFromCartBtn text-red-500" data-index="${i}">x</button></li>`).join("")}
            </ul>
            <p class="font-bold mt-2">Subtotal: KSh ${cart.reduce((s,i)=>s+i.price,0)} | Total (incl. Service Fee: KSh ${SERVICE_FEE})</p>
            <div class="mt-2">
                <input id="custName" placeholder="Your Name" class="border p-2 w-full mt-2" />
                <input id="custPhone" placeholder="Phone Number" class="border p-2 w-full mt-2" />
                <button class="bg-blue-500 text-white px-3 py-1 mt-2 rounded" id="placeOrder">Place Order</button>
            </div>`}
        </div>`;
        return;
    }

    // --- Orders Tab ---
    if(currentTab === "orders") {
        if(currentHotelId) {
            const myOrders = orders.filter(o => o.hotelId === currentHotelId);
            app.innerHTML = `<h2 class="text-xl font-semibold mb-4">My Hotel Orders</h2>` +
            (myOrders.length === 0 ? `<p class="text-gray-500">No orders yet.</p>` :
            `<ul class="space-y-3">
            ${myOrders.map(o => `<li class="bg-white shadow rounded p-3">
                <h3 class="font-semibold">Order #${o.id}</h3>
                <p class="text-sm"><strong>Customer:</strong> ${escapeHTML(o.customerName)} (${escapeHTML(o.customerPhone)})</p>
                <ul class="text-sm text-gray-600 mb-2">
                    ${o.items.map(i => `<li>${escapeHTML(i.name)} - KSh ${i.price}</li>`).join("")}
                </ul>
                <p>Pay Food Cost to Hotel Till: ${escapeHTML(getHotelById(o.hotelId).till)} ‚Äî <strong>${o.hotelPaid ? "‚úÖ Paid" : "‚ùå Not Paid"}</strong></p>
                ${!o.hotelPaid ? `<button class="markHotelPaidBtn bg-green-500 text-white px-2 py-1 rounded mt-1" data-id="${o.id}">Mark Hotel Paid</button>` : ""}
            </li>`).join("")}
            </ul>`);
        } else {
            app.innerHTML = `<h2 class="text-xl font-semibold mb-4">Customer Orders</h2>` +
            (orders.length === 0 ? `<p class="text-gray-500">No orders yet.</p>` :
            `<ul class="space-y-3">
            ${orders.map(o => `<li class="bg-white shadow rounded p-3">
                <h3 class="font-semibold">Order #${o.id} (Hotel: ${escapeHTML(getHotelById(o.hotelId).name)})</h3>
                <p>Customer: ${escapeHTML(o.customerName)} (${escapeHTML(o.customerPhone)})</p>
                <ul class="text-sm text-gray-600 mb-2">
                    ${o.items.map(i => `<li>${escapeHTML(i.name)} - KSh ${i.price}</li>`).join("")}
                </ul>
                <p>Subtotal: KSh ${o.subtotal}</p>
                <p>Pay Food Cost to Hotel Till: ${escapeHTML(getHotelById(o.hotelId).till)}</p>
            </li>`).join("")}
            </ul>`);
        }
        return;
    }

    // --- Hotel Tab ---
    if(currentTab === "hotel") {
        if(currentHotelId) {
            const hotel = hotels.find(h => h.id === currentHotelId);
            const rest = restaurants.find(r => r.hotelId === currentHotelId) || {menu: []};
            if(hotel.blocked) {
                app.innerHTML = `<p class="bg-red-100 p-4 rounded">Your account is blocked. Contact admin to continue services.</p>
                <button id="logoutHotel" class="bg-red-500 text-white px-3 py-1 rounded mt-2">Logout</button>`;
                return;
            }
            if(!hotel.subscriptionExpiry || new Date(hotel.subscriptionExpiry) <= new Date()) {
                app.innerHTML = `<div class="bg-white p-4 shadow rounded">
                <h2 class="text-xl font-semibold mb-2">Subscription Required</h2>
                <p>Your 7-day trial has ended. Pay KSh ${SUBSCRIPTION_FEE} to ${OWNER_NUMBER} via M-Pesa to continue.</p>
                <button id="logoutHotel" class="bg-red-500 text-white px-3 py-1 rounded mt-4">Logout</button></div>`;
                return;
            }
            app.innerHTML = `<h2 class="text-xl font-semibold mb-4">Welcome, ${escapeHTML(hotel.name)}</h2>
            <button id="logoutHotel" class="bg-red-500 text-white px-3 py-1 rounded">Logout</button>
            <div class="mt-4 bg-white p-4 shadow rounded">
            <h3 class="font-bold mb-2">Manage Menu</h3>
            <form id="addMenuItem" class="flex gap-2 mb-2">
                <input name="name" placeholder="Item Name" class="border p-1 flex-1" />
                <input name="price" type="number" placeholder="Price" class="border p-1 w-24" />
                <input name="desc" placeholder="Description" class="border p-1 flex-1" />
                <button class="bg-green-500 text-white px-2 py-1 rounded">Add</button>
            </form>
            <ul>
                ${rest.menu.map((m,i)=>`<li>${escapeHTML(m.name)} (${escapeHTML(m.description || 'No description')}) - KSh ${m.price} <button class="removeMenuItemBtn text-red-500" data-index="${i}">x</button></li>`).join("")}
            </ul></div>`;
        } else {
            app.innerHTML = `<h2 class="text-xl font-semibold mb-4">Hotel Login</h2>
            <form id="hotelLogin" class="space-y-2 mb-4">
                <input name="name" placeholder="Hotel Name" class="border p-2 w-full" />
                <input name="pass" type="password" placeholder="Password" class="border p-2 w-full" />
                <button class="bg-green-600 text-white px-3 py-1 rounded">Login</button>
            </form>
            <h2 class="text-xl font-semibold mb-2">Register Hotel</h2>
            <form id="hotelRegister" class="space-y-2">
                <input name="name" placeholder="Hotel Name" class="border p-2 w-full" />
                <input name="pass" type="password" placeholder="Password" class="border p-2 w-full" />
                <input name="till" placeholder="Till Number" class="border p-2 w-full" />
                <button class="bg-blue-600 text-white px-3 py-1 rounded">Register</button>
            </form>`;
        }
        return;
    }

    // --- Admin Tab ---
    if(currentTab === "admin") {
        if(currentAdmin) {
            app.innerHTML = `<h2 class="text-xl font-semibold mb-4">Admin Panel</h2>
            <ul class="space-y-3">
            ${hotels.map(h => `<li class="bg-white shadow rounded p-3">
                <h3 class="font-semibold">${escapeHTML(h.name)}</h3>
                <p>Till: ${escapeHTML(h.till)}</p>
                <p>Subscription Expires: ${h.subscriptionExpiry ? new Date(h.subscriptionExpiry).toLocaleString() : "Not Paid"}</p>
                <p>Status: ${h.blocked ? "Blocked ‚ùå" : "Active ‚úÖ"}</p>
                <button class="toggleBlockBtn bg-yellow-500 text-white px-2 py-1 rounded mt-1" data-id="${h.id}">
                ${h.blocked ? "Unblock" : "Block"}</button>
            </li>`).join("")}
            </ul>
            <button id="logoutAdmin" class="bg-red-500 text-white px-3 py-1 rounded mt-4">Logout</button>`;
        } else {
            app.innerHTML = `<h2 class="text-xl font-semibold mb-4">Admin Login</h2>
            <form id="adminLogin" class="space-y-2">
                <input name="name" placeholder="Username" class="border p-2 w-full" />
                <input name="pass" type="password" placeholder="Password" class="border p-2 w-full" />
                <button class="bg-purple-600 text-white px-3 py-1 rounded">Login</button>
            </form>`;
        }
        return;
    }
}
// ------------------ END RENDER FUNCTION ------------------

// ------------------ EVENT LISTENERS ------------------
document.addEventListener('click', e => {
    if(e.target.classList.contains('addToCartBtn')) {
        const hotelId = e.target.dataset.hotel;
        const name = e.target.dataset.name;
        const price = parseFloat(e.target.dataset.price);
        cart.push({name, price, hotelId});
        render();
    }
    if(e.target.classList.contains('removeFromCartBtn')) {
        const index = parseInt(e.target.dataset.index);
        cart.splice(index,1);
        render();
    }
    if(e.target.id === "placeOrder") {
        const custName = document.getElementById('custName').value.trim();
        const custPhone = document.getElementById('custPhone').value.trim();
        if(!custName || !custPhone) return alert("Enter name and phone!");
        const id = orders.length + 1;
        const subtotal = cart.reduce((s,i)=>s+i.price,0);
        orders.push({
            id, customerName:custName, customerPhone:custPhone,
            items:[...cart], hotelId: cart[0]?.hotelId || null,
            subtotal, serviceFee: SERVICE_FEE, total: subtotal+SERVICE_FEE,
            hotelPaid:false, serviceFeePaid:false
        });
        cart=[];
        saveData(); render();
    }
    if(e.target.classList.contains('markHotelPaidBtn')) {
        const id = parseInt(e.target.dataset.id);
        const order = orders.find(o=>o.id===id);
        if(order) order.hotelPaid = true;
        saveData(); render();
    }
    if(e.target.classList.contains('removeMenuItemBtn')) {
        const index = parseInt(e.target.dataset.index);
        const rest = restaurants.find(r=>r.hotelId===currentHotelId);
        rest.menu.splice(index,1);
        saveData(); render();
    }
    if(e.target.id === "logoutHotel") { currentHotelId=null; render(); }
    if(e.target.id === "logoutAdmin") { currentAdmin=null; render(); }
    if(e.target.classList.contains('toggleBlockBtn')) {
        const id = e.target.dataset.id;
        const hotel = hotels.find(h=>h.id===id);
        hotel.blocked = !hotel.blocked;
        saveData(); render();
    }
});

document.addEventListener('submit', e => {
    e.preventDefault();
    if(e.target.id === "hotelRegister") {
        const name = e.target.name.value.trim();
        const pass = e.target.pass.value;
        const till = e.target.till.value.trim();
        if(!name || !pass || !till) return alert("Fill all fields");
        const id = Date.now().toString();
        const expiry = new Date();
        expiry.setDate(expiry.getDate()+7); // 7-day trial
        hotels.push({id, name, pass, till, subscriptionExpiry:expiry.toISOString(), blocked:false});
        restaurants.push({id:Date.now().toString(), hotelId:id, name:name + " Menu", description:"", menu:[]});
        saveData(); alert("Registered! Now login."); render();
    }
    if(e.target.id === "hotelLogin") {
        const name = e.target.name.value.trim();
        const pass = e.target.pass.value;
        const hotel = hotels.find(h=>h.name===name && h.pass===pass);
        if(hotel) { currentHotelId = hotel.id; render(); }
        else alert("Invalid credentials");
    }
    if(e.target.id === "adminLogin") {
        const name = e.target.name.value.trim();
        const pass = e.target.pass.value;
        if(name === ADMIN_USER.name && pass === ADMIN_USER.pass) {
            currentAdmin = name; render();
        } else alert("Invalid admin credentials");
    }
    if(e.target.id === "addMenuItem") {
        const hotel = hotels.find(h=>h.id===currentHotelId);
        const rest = restaurants.find(r=>r.hotelId===currentHotelId);
        const name = e.target.name.value.trim();
        const price = parseFloat(e.target.price.value);
        const desc = e.target.desc.value.trim();
        if(!name || isNaN(price)) return alert("Enter valid name and price");
        rest.menu.push({name, price, description: desc});
        saveData(); render();
    }
});

document.querySelectorAll('.tab').forEach(btn => {
    btn.addEventListener('click', e => {
        currentTab = e.target.dataset.tab;
        document.querySelectorAll('.tab').forEach(b => b.classList.remove('font-bold','underline'));
        e.target.classList.add('font-bold','underline');
        render();
    });
});

document.getElementById('toggleTheme').addEventListener('click', () => {
    isDark = !isDark; document.body.classList.toggle('dark', isDark); localStorage.setItem('darkMode', isDark);
});
document.getElementById('resetData').addEventListener('click', () => {
    if(confirm('Clear all data?')){
        localStorage.clear(); hotels=[]; restaurants=[]; orders=[]; cart=[]; currentHotelId=null; currentAdmin=null;
        render();
    }
});

// INIT
render();
</script>
</body>
</html>
